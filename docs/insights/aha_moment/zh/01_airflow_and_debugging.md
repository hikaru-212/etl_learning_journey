# ğŸŒªï¸ å¾ Airflow æ™æ‰ â†’ ğŸ’¡ Debugging é “æ‚Ÿ â†’ Core vs Enablers
> [Switch to English Version / è·³è‡³è‹±æ–‡ç‰ˆ](../en/01_airflow_and_debugging.md)

## Airflow çš„ç¾å¯¦æª¢é©— 
*(2025-09-07)*

åœ¨ç‚ºäº†è¨­å®š Airflow æäº†ä¸€æ•´å¤©ï¼ˆåƒæ•¸ã€ç’°å¢ƒè¨­ç½®ã€ç„¡ç›¡çš„éŒ¯èª¤ï¼‰å¾Œï¼Œæˆ‘å¹¾ä¹è¦æ”¾æ£„ã€‚  
ç•¶å®ƒçµ‚æ–¼èƒ½é‹ä½œæ™‚ï¼Œæˆ‘çªç„¶æ„è­˜åˆ°ï¼š

> **ã€Œç­‰ç­‰â€¦â€¦é€™ä¸å°±æ˜¯æˆ‘æœ¬åœ°çš„ ETLï¼Œåªæ˜¯å¤šäº†å¹¾å€‹æ­¥é©Ÿå—ï¼Ÿã€**

æ›´æ·±å…¥åœ°æª¢è¦–ç¨‹å¼æ¶æ§‹ï¼Œæˆ‘ç™¼ç¾ï¼š
- Airflow = **æ’ç¨‹å™¨ + ç›£æ§å™¨ + Python åŸ·è¡Œå™¨**  
- æˆ‘çš„ **æ ¸å¿ƒè½‰æ›é‚è¼¯å®Œå…¨æ²’è®Š**  
- çœŸæ­£çš„åƒ¹å€¼å…¶å¯¦æ˜¯ **è‡ªå‹•åŒ–èˆ‡å¯è§€æ¸¬æ€§**ï¼Œè€Œä¸æ˜¯è½‰æ›æœ¬èº«  

**æ•¸å­¸ä¸Šçš„æ´è¦‹**ï¼šæŠŠè¤‡é›œæ€§å‰æ‰å¾Œï¼Œä½ æœƒç™¼ç¾åº•å±¤é‚„æ˜¯ç›¸åŒçš„é‹ç®—ã€‚  
å·¥å…·æ”¹è®Šçš„æ˜¯ **åŸ·è¡Œç’°å¢ƒ**ï¼Œè€Œä¸æ˜¯ **è¨ˆç®—æœ¬è³ª**ã€‚  

**é—œéµå­¸ç¿’**ï¼šåœ¨é™·å…¥å·¥å…·è¤‡é›œæ€§ä¹‹å‰ï¼Œå…ˆå•è‡ªå·±ï¼š  
**ã€Œä¸å¯ç´„çš„æ ¸å¿ƒæ˜¯ä»€éº¼ï¼Ÿã€**

---

## ğŸ’¡ Debugging çš„ã€Œé “æ‚Ÿã€ï¼šå¾æŒ«æŠ˜åˆ°ç³»çµ±æ€ç¶­ 
*(2025-09-06)*

åœ¨èª¿è©¦ä¸€å€‹é ‘å›ºçš„ bug å¥½å¹¾å€‹å°æ™‚å¾Œï¼Œæˆ‘å¿«è¦æ”¾æ£„ã€‚  
èµ°å»åƒæ™šé¤çš„é€”ä¸­ï¼Œæˆ‘çªç„¶æ„è­˜åˆ°ï¼š

**ç¨‹å¼è¨­è¨ˆå…¶å¯¦å°±æ˜¯åœ¨å»ºä¸€åº§æ©‹ï¼ŒæŠŠè¼¸å…¥è½‰æ›æˆæœŸæœ›çš„è¼¸å‡ºã€‚**

### è¦–è§’çš„è½‰æ›
èˆ‡å…¶è¿·å¤±åœ¨ç´°ç¯€ï¼Œæˆ‘é–‹å§‹å•è‡ªå·±ï¼š
- æˆ‘çš„ **è¼¸å…¥** åˆ°åº•æ˜¯ä»€éº¼ï¼Ÿ  
- æˆ‘çœŸæ­£æƒ³è¦çš„ **è¼¸å‡º** æ˜¯ä»€éº¼ï¼Ÿ  
- åœ¨å…©è€…ä¹‹é–“ï¼Œ**æœ€ç°¡å–®çš„æ©‹æ¨‘** æ˜¯ä»€éº¼ï¼Ÿ  

é€™å€‹å¿ƒæ™ºæ¨¡å‹ï¼Œå¾ debug å–®ä¸€å‡½å¼ï¼Œä¸€è·¯å»¶å±•åˆ°è¨­è¨ˆå®Œæ•´ ETL ç³»çµ±ï¼š  
![Input â†’ Bridge â†’ Output](../../../assets/input_output_bridge.png)

è³‡æ–™å·¥ç¨‹ = è¼¸å…¥ï¼ˆé«’è³‡æ–™ï¼‰  
â†’ æ©‹æ¨‘ï¼ˆETL pipelineï¼‰  
â†’ è¼¸å‡ºï¼ˆä¹¾æ·¨ã€å¯åˆ†æçš„è³‡æ–™ï¼‰

### é€€ä¸€æ­¥æ›´æ¸…æ¥š
æœ‰æ™‚å€™æœ€é‡è¦çš„æ´è¦‹ä¸æ˜¯åœ¨è¢å¹•å‰ï¼Œè€Œæ˜¯åœ¨å•è‡ªå·±ï¼š  
**ã€Œæˆ‘å…¶å¯¦çœŸæ­£è¦å®Œæˆçš„æ˜¯ä»€éº¼ï¼Ÿã€**  

é€™ç¨®æ€ç¶­ä¸æ˜¯æ†‘ç©ºå‡ºç¾çš„ï¼Œè€Œæ˜¯ç”±æ–¼é•·æ™‚é–“çš„æŒ«æŠ˜èˆ‡åæ€ç´¯ç©å‡ºä¾†ã€‚  
å®ƒä¾†å¾—çªç„¶ï¼Œä½†åŒæ™‚ä¹Ÿå¾ˆå¯é ï¼Œå› ç‚ºå®ƒå»ºç«‹åœ¨ä¹‹å‰çš„æ™æ‰ä¹‹ä¸Šã€‚

### æ•¸å­¸é€£çµ
é€™å€‹ Inputâ€“Processâ€“Output æ¶æ§‹ï¼Œå…¶å¯¦å°±æ˜¯ **f: X â†’ Y**ã€‚  
æ¸…æ™°ä¾†è‡ªæ–¼ï¼š  
- å®šç¾© **domainï¼ˆè¼¸å…¥ç©ºé–“ï¼‰**  
- å®šç¾© **codomainï¼ˆè¼¸å‡ºç©ºé–“ï¼‰**  
- æ‰¾åˆ°èƒ½æŠŠå…©è€…é€£æ¥èµ·ä¾†çš„ **è½‰æ›**  

ä¸€é–‹å§‹åªæ˜¯ debug çš„å°é “æ‚Ÿï¼Œæœ€å¾Œå»æ¼”åŒ–æˆä¸€å€‹é€šç”¨çš„ **ç³»çµ±æ€ç¶­æ¡†æ¶**ã€‚

---

## ã€ŒAhaï¼ã€æ™‚åˆ» â€” Core vs Enablers èª•ç”Ÿ 
*(2025-09-07)*

åœ¨èˆ‡ Airflow çš„è¤‡é›œæ€§æé¬¥å¾Œï¼Œæˆ‘çœ‹åˆ°äº†æ›´å¤§çš„æ¨¡å¼ï¼š

- **Core å¾æœªæ”¹è®Š** â€”â€” ä¸è«–åœ¨æœ¬åœ°é‚„æ˜¯ Airflowï¼Œè³‡æ–™è½‰æ›é‚è¼¯éƒ½ä¸€æ¨£ã€‚  
- **å…¶ä»–ä¸€åˆ‡éƒ½æ˜¯ Enabler**ï¼š  
  - **Airflow** â†’ å•Ÿç”¨æ’ç¨‹èˆ‡ç›£æ§  
  - **Pandera** â†’ å•Ÿç”¨è³‡æ–™çµæ§‹é©—è­‰  
  - **Unit tests** â†’ å•Ÿç”¨é‚è¼¯é©—è­‰  
  - **Secrets/Env** â†’ å•Ÿç”¨å®‰å…¨é…ç½®  
  - **Logging/Metrics** â†’ å•Ÿç”¨å¯è§€æ¸¬æ€§  
  - **å†ªç­‰å¯«å…¥èˆ‡é‡è©¦** â†’ å•Ÿç”¨å¯é æ€§  

**çµ±ä¸€çš„æ´è¦‹**ï¼šæ‰€æœ‰å·¥å…·ï¼Œä¸æ˜¯ **åŸ·è¡Œå·¥ä½œï¼ˆCoreï¼‰**ï¼Œå°±æ˜¯ **ä¿è­·å·¥ä½œï¼ˆEnablersï¼‰**ã€‚

### åˆ¤æ–·æ¸…å–®
1. é€™ä¸€æ­¥æ˜¯å¦ **æ”¹è®Šäº†æ¥­å‹™æ„ç¾©**ï¼Ÿï¼ˆæ˜¯ â†’ Coreï¼›å¦ â†’ Enablerï¼‰  
2. å¦‚æœç§»é™¤ï¼Œ**è¼¸å‡ºçš„æ•¸å€¼æœƒä¸æœƒè®Š**ï¼Ÿï¼ˆæœƒ â†’ Coreï¼›ä¸æœƒ â†’ Enablerï¼‰  
3. é€™ä¸€æ­¥çš„ç›®çš„æ˜¯å¦æ˜¯ **é©—è­‰ / å¯è§€æ¸¬ / æ’ç¨‹ / å®‰å…¨ / ç©©å®šæ€§**ï¼Ÿï¼ˆæ˜¯ â†’ Enablerï¼‰  

> ğŸ“Œ å»ºè­°åœ–ç¤º: ![Core vs Enablers](../../../assets/core_vs_enablers.png)  
> ä¸­å¿ƒ = Coreï¼Œå¤–åœå€å¡Š = Enablersã€‚

### ğŸ’¡ é‡è¦æé†’ï¼š
Core èˆ‡ Enabler çš„å€åˆ¥ä¸¦éçµ•å°ã€‚  
éš¨è‘—å°ˆæ¡ˆè¦æ¨¡æ“´å¤§ã€åœ˜éšŠæˆé•·ã€ç³»çµ±ç©©å®šæ€§éœ€æ±‚å¢åŠ ï¼Œ  
åŸæœ¬è¢«è¦–ç‚ºã€ŒEnablerã€çš„æ±è¥¿ â€”â€” åƒæ˜¯å·¥ä½œæµç·¨æ’æˆ–æ¬Šé™ç®¡æ§ â€”â€”  
å¯èƒ½åœ¨æ–°çš„éšæ®µè®Šæˆ **ä¸å¯æˆ–ç¼ºçš„ Core**ï¼Œå› ç‚ºå®ƒç›´æ¥å½±éŸ¿å¯é æ€§èˆ‡å¯ç¶­è­·æ€§ã€‚  

---

## ğŸ”§ åœ¨ç¨‹å¼ä¸­æ©‹æ¥ Core èˆ‡ Enablers

### Coreï¼ˆæ”¹è®Šæ¥­å‹™æ„ç¾©ï¼‰
- **æ­£è¦åŒ–èˆ‡æ¸…æ´—**ï¼šå–®ä½/å¹£åˆ¥è½‰æ›ã€æ™‚å€å°é½Šã€æ¬„ä½æ¨™æº–åŒ–  
- **è¦å‰‡èˆ‡è¡ç”Ÿ**ï¼šç¨…å‹™/æŠ˜æ‰£/åˆ†é¡è¦å‰‡ã€ä»£ç†éµç”Ÿæˆ  
- **èšåˆèˆ‡æŒ‡æ¨™**ï¼šgroupbyã€è¦–çª—å‡½æ•¸ã€KPIï¼ˆAOVã€è½‰æ›ç‡ï¼‰  
- **èªæ„å»é‡**ï¼šå®šç¾©ä»€éº¼æ‰ç®—ã€ŒåŒä¸€ç­†è¨‚å–®ã€  

### Enablersï¼ˆä¸æ”¹è®Šæ„ç¾©ï¼Œç¢ºä¿æ­£ç¢ºï¼‰
- **Schema é©—è­‰** (Pandera/pydantic)ï¼šå‹åˆ¥ã€å”¯ä¸€æ€§ã€ç¯„åœã€å¤–éµå½¢ç‹€  
- **éš”é›¢èˆ‡æ‹’æ”¶**ï¼šå°‡éŒ¯èª¤åˆ—éš”é›¢ä¸¦é™„ç†ç”±ï¼Œé¿å…éœé»˜éºå¤±  
- **å†ªç­‰å¯«å…¥**ï¼š`_tmp` â†’ åŸå­æ”¹åã€æ‰¹æ¬¡ upsertã€å»é‡é–  
- **é‡è©¦ / backoff / timeout**ï¼šç¢ºä¿ I/O èˆ‡å¤–éƒ¨æœå‹™ç©©å®šæ€§  
- **æ—¥èªŒèˆ‡ç›£æ§**ï¼šè¼¸å…¥/è¼¸å‡ºæ•¸é‡ã€æ‹’æ”¶æ•¸ã€å»¶é²ã€SLA/SLO  
- **è¨­å®š / æ©Ÿå¯†**ï¼š`.env` / vaultï¼›DB æœ€å°æ¬Šé™è§’è‰²  
- **ç·¨æ’**ï¼šAirflow DAG æ’ç¨‹ã€ä¾è³´ã€é€šçŸ¥ã€é‡è·‘  
- **æ¸¬è©¦**ï¼šå–®å…ƒã€æ•´åˆã€å¥‘ç´„/schema snapshot  

---

### æœ€å° ETL éª¨æ¶
```python
def extract(src):
    # Enabler: é‡è©¦/backoffã€logging
    return read_raw(src)

def parse_and_normalize(df):
    # Core: æ­£è¦åŒ–ã€å–®ä½/æ™‚å€è½‰æ›ã€èªæ„å°é½Š
    return normalized_df

def transform_business_rules(df):
    # Core: æ¥­å‹™é‚è¼¯ï¼ˆç¨…å‹™ã€æŠ˜æ‰£ã€åˆ†é¡ï¼‰ã€æŒ‡æ¨™
    return metrics_df

def validate(df):
    # Enabler: schema é©—è­‰ï¼ˆä¸æ”¹è®Šèªæ„ï¼Œåªéæ¿¾/éš”é›¢ç„¡æ•ˆåˆ—ï¼‰
    return good_df, rejected_df

def load(df, table, conn):
    # Enabler: å†ªç­‰å¯«å…¥ (_tmp â†’ rename)ã€é‡è©¦ã€ç¨½æ ¸æ—¥èªŒ
    atomic_write(df, table, conn)

def pipeline():
    raw = extract("raw_path")
    good, bad = validate(parse_and_normalize(raw))
    result = transform_business_rules(good)
    load(result, "silver.metrics_daily", conn="RO_LEAST_PRIV")

# å¿«é€Ÿåˆ¤æ–·
# å¦‚æœç§»é™¤æœƒæ”¹è®Šæ¥­å‹™è¼¸å‡º â†’ Core
# å¦‚æœç§»é™¤ä¸æ”¹è®Šæ„ç¾©ï¼Œä½†æœƒå¤±å»å®‰å…¨/å¯è§€æ¸¬/å¯é æ€§ â†’ Enabler
```
--- 

## ğŸ“ å»¶ä¼¸é–±è®€

æƒ³äº†è§£ Core vs. Enablers å¦‚ä½•åœ¨ä¸åŒæƒ…å¢ƒä¸‹å‹•æ…‹è½‰æ›ï¼Œ
è«‹åƒè€ƒ [01B_core_vs_enablers_dynamic](./01B_core_vs_enablers_dynamic.md) æ¶æ§‹å¸«çš„å·¥å…·ç®±ï¼šCore èˆ‡ Enablers çš„å‹•æ…‹è¦–è§’
ã€‚
